<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä»¿å¾®ä¿¡Â·AIèŠå¤©ï¼ˆå®Œæ•´ä¿®æ­£ç‰ˆï¼‰</title>
<style>
  :root{
    --wx-green:#07c160; --bg:#f5f5f7; --card:#fff; --text:#111; --muted:#888;
    --bubble-me:#b2f27a; --bubble-ai:#ffffff; --line:#eaeaea;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial;background:var(--bg);color:var(--text)}
  header.appbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--card);border-bottom:1px solid var(--line)}
  header .title{font-weight:600}
  header .iconbtn{background:#f6f6f6;border:1px solid var(--line);padding:6px 10px;border-radius:10px}
  .page{display:none;min-height:calc(100vh - 56px);padding:10px}
  .page.active{display:block}
  nav.tabbar{position:fixed;bottom:0;left:0;right:0;height:56px;background:var(--card);border-top:1px solid var(--line);display:flex}
  nav.tabbar button{flex:1;border:none;background:none;font-size:13px}
  nav.tabbar button.active{color:var(--wx-green);font-weight:600}
  .list{background:var(--card);border-radius:12px;overflow:hidden}
  .item{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);cursor:pointer}
  .item:last-child{border-bottom:none}
  .avatar{width:44px;height:44px;border-radius:8px;background:#eee;object-fit:cover}
  .muted{color:var(--muted);font-size:12px}
  .btn{background:var(--wx-green);color:#fff;border:none;border-radius:10px;padding:8px 12px}
  .btn.ghost{background:#f6f6f6;color:#333;border:1px solid var(--line)}
  .row{display:flex;gap:8px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  /* Chat */
  .chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 56px)}
  .chat-list{flex:1;overflow:auto;padding:10px}
  .bubble{max-width:78%;padding:8px 10px;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .me{display:flex;justify-content:flex-end;margin:8px 0}
  .me .bubble{background:var(--bubble-me)}
  .ai{display:flex;justify-content:flex-start;margin:8px 0}
  .ai .bubble{background:var(--bubble-ai);border:1px solid var(--line)}
  .time{display:block;text-align:center;color:#999;font-size:12px;margin:8px 0}
  .chat-inputbar{border-top:1px solid var(--line);padding:8px;background:var(--card)}
  .chat-inputbar .tools{display:flex;align-items:center;gap:8px}
  .emo-panel,.plus-panel{margin-top:6px;border-top:1px dashed var(--line);padding-top:8px}
  input[type=text],input[type=number],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  textarea{min-height:100px}
  .pill{padding:6px 10px;border:1px solid var(--line);background:#fafafa;border-radius:999px;font-size:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:20}
  .modal.show{display:flex}
  .sheet{width:100%;max-height:88vh;overflow:auto;background:var(--card);border-radius:16px 16px 0 0;padding:12px 12px 16px}
  .sheet h3{margin:6px 0 12px 0}
  .section{background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
  .actions{display:flex;gap:10px;position:sticky;bottom:0;background:transparent;margin-top:10px}
  .moment{background:var(--card);border-radius:12px;padding:10px;margin:10px 0;border:1px solid var(--line)}
  .small{font-size:12px;color:var(--muted)}
  /* responsive small */
  @media (min-width:600px){ .sheet{max-width:600px;margin:0 auto;border-radius:12px} }
</style>
</head>
<body>

<header class="appbar">
  <div class="title" id="app-title">æ¶ˆæ¯</div>
  <button id="top-plus" class="iconbtn" title="æ–°å»ºè§’è‰²">ï¼‹</button>
</header>

<!-- æ¶ˆæ¯åˆ—è¡¨é¡µ -->
<main id="page-chatlist" class="page active">
  <div id="chatlist" class="list"></div>
</main>

<!-- é€šè®¯å½•é¡µ -->
<main id="page-contacts" class="page">
  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center;margin:6px 0 10px">
      <div class="muted">å¥½å‹åˆ†ç»„</div>
      <button class="pill" onclick="openManageGroups()">ç®¡ç†åˆ†ç»„</button>
    </div>
    <div id="contact-groups" class="list"></div>
  </div>
</main>

<!-- æœ‹å‹åœˆé¡µ -->
<main id="page-moments" class="page">
  <div class="section">
    <label>æ–‡å­—</label>
    <textarea id="moment-text" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
    <label style="margin-top:8px">å›¾ç‰‡ URLï¼ˆå¯é€‰ï¼‰</label>
    <input id="moment-img" placeholder="https://...jpg/png" />
    <label style="margin-top:8px">å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰</label>
    <input id="moment-img-desc" placeholder="å›¾è¯´ï¼šåœ¨æµ·è¾¹..." />
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="postMoment()">å‘å¸ƒ</button>
      <button class="btn ghost" onclick="clearMoments()">æ¸…ç©º</button>
    </div>
  </div>
  <div id="moments-list"></div>
</main>

<!-- æˆ‘çš„é¡µï¼ˆAPI & ä¸–ç•Œä¹¦ï¼‰ -->
<main id="page-me" class="page">
  <div class="section">
    <h3>API è®¾ç½®</h3>
    <label>Base URL</label>
    <input id="api-base" placeholder="å¦‚ï¼šhttps://api.openai.com/v1" />
    <label>API Key</label>
    <input id="api-key" placeholder="sk-..." />
    <label>Model</label>
    <input id="api-model" placeholder="gpt-5" value="gpt-5"/>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="saveApi()">ä¿å­˜</button>
      <button class="btn ghost" onclick="testApi()">æµ‹è¯•</button>
    </div>
  </div>

  <div class="section">
    <h3>ä¸–ç•Œä¹¦ï¼ˆWorldBookï¼‰</h3>
    <label>æ ‡é¢˜</label><input id="wb-title" placeholder="ä¸–ç•Œä¹¦æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰"/>
    <label style="margin-top:8px">å†…å®¹</label><textarea id="wb-content" placeholder="ä¸–ç•Œè®¾å®šã€å†å²ã€åå¥½ç­‰..."></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="addWorld()">æ·»åŠ </button>
    </div>
    <div id="worldbook-list" style="margin-top:12px"></div>
  </div>
</main>

<!-- èŠå¤©çª—å£ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
<main id="page-chat" class="page"></main>

<!-- åº•éƒ¨æ ‡ç­¾ -->
<nav class="tabbar">
  <button class="active" onclick="switchTab('chatlist')">æ¶ˆæ¯</button>
  <button onclick="switchTab('contacts')">é€šè®¯å½•</button>
  <button onclick="switchTab('moments')">æœ‹å‹åœˆ</button>
  <button onclick="switchTab('me')">æˆ‘çš„</button>
</nav>

<!-- æ–°å»ºè§’è‰² Modal -->
<section id="modal-newrole" class="modal" onclick="maskClose(event,'modal-newrole')">
  <div class="sheet" onclick="event.stopPropagation()">
    <h3>åˆ›å»ºæ–°è§’è‰²</h3>
    <div class="section">
      <label>å¤‡æ³¨å / ç¾¤å</label>
      <input id="nr-remark" placeholder="ä¾‹å¦‚ï¼šå°æã€äº§å“ç¾¤..." />
      <label style="margin-top:8px">å¥½å‹åˆ†ç»„</label>
      <div class="row" style="margin-top:6px">
        <select id="nr-group" style="flex:1"></select>
        <button class="pill" onclick="openManageGroups()">ç®¡ç†åˆ†ç»„</button>
      </div>
      <label style="margin-top:8px">å…³è”ä¸–ç•Œä¹¦ï¼ˆå¤šé€‰ï¼‰</label>
      <div id="nr-worldbooks" class="row" style="flex-wrap:wrap;margin-top:6px"></div>
      <label style="margin-top:8px">å¯¹æ–¹äººè®¾ (AI Persona)</label>
      <textarea id="nr-ai-persona" placeholder="å†™Taçš„æ€§æ ¼ã€èº«ä»½ã€è¯´è¯æ–¹å¼..."></textarea>
      <label style="margin-top:8px">å¯¹æ–¹å¤´åƒ URL</label>
      <input id="nr-avatar" placeholder="https://...png/jpg" />
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <img id="nr-avatar-preview" class="avatar" alt="">
      </div>
    </div>

    <div class="section">
      <label>æˆ‘çš„äººè®¾ (My Persona)</label>
      <textarea id="nr-my-persona" placeholder="è®©AIçŸ¥é“ä½ æ˜¯è°ã€ä½ çš„å£å»..."></textarea>
      <label style="margin-top:8px">æˆ‘çš„å¤´åƒ URL</label>
      <input id="nr-my-avatar" placeholder="æˆ‘çš„å¤´åƒURL"/>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <img id="nr-my-avatar-preview" class="avatar" alt="">
      </div>
      <label style="margin-top:8px">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label>
      <input id="nr-memory" type="number" min="4" max="50" value="12"/>
    </div>

    <div class="actions">
      <button class="btn ghost" onclick="closeModal('modal-newrole')">å–æ¶ˆ</button>
      <button class="btn" onclick="confirmNewRole()">ç¡®å®š</button>
    </div>
  </div>
</section>

<!-- è§’è‰²è®¾ç½® Modal -->
<section id="modal-role-settings" class="modal" onclick="maskClose(event,'modal-role-settings')">
  <div class="sheet" onclick="event.stopPropagation()">
    <h3>èŠå¤©è®¾ç½®</h3>
    <div class="section">
      <label>å¤‡æ³¨å / ç¾¤å</label><input id="rs-remark"/>
      <label style="margin-top:8px">å¥½å‹åˆ†ç»„</label>
      <div class="row" style="margin-top:6px"><select id="rs-group" style="flex:1"></select><button class="pill" onclick="openManageGroups()">ç®¡ç†åˆ†ç»„</button></div>
      <label style="margin-top:8px">å…³è”ä¸–ç•Œä¹¦ï¼ˆå¤šé€‰ï¼‰</label>
      <div id="rs-worldbooks" class="row" style="flex-wrap:wrap;margin-top:6px"></div>
      <label style="margin-top:8px">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="rs-ai-persona"></textarea>
      <label style="margin-top:8px">å¯¹æ–¹å¤´åƒ URL</label><input id="rs-avatar" placeholder="å¤´åƒURL"/>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <img id="rs-avatar-preview" class="avatar" alt="">
      </div>
    </div>
    <div class="section">
      <label>æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="rs-my-persona"></textarea>
      <label style="margin-top:8px">æˆ‘çš„å¤´åƒ URL</label><input id="rs-my-avatar" placeholder="æˆ‘çš„å¤´åƒURL"/>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <img id="rs-my-avatar-preview" class="avatar" alt="">
      </div>
      <label style="margin-top:8px">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input id="rs-memory" type="number" min="4" max="50"/>
    </div>
    <div class="actions">
      <button class="btn ghost" onclick="closeModal('modal-role-settings')">å–æ¶ˆ</button>
      <button class="btn" onclick="saveRoleSettings()">ä¿å­˜</button>
    </div>
  </div>
</section>

<!-- åˆ†ç»„ç®¡ç† Modal -->
<section id="modal-groups" class="modal" onclick="maskClose(event,'modal-groups')">
  <div class="sheet" onclick="event.stopPropagation()">
    <h3>ç®¡ç†åˆ†ç»„</h3>
    <div id="group-list" class="list"></div>
    <div class="row" style="margin-top:10px">
      <input id="new-group-name" placeholder="æ–°å¢åˆ†ç»„å"/>
      <button class="btn" onclick="addGroup()">æ·»åŠ </button>
    </div>
    <div class="actions">
      <button class="btn" style="flex:1" onclick="closeModal('modal-groups')">å®Œæˆ</button>
    </div>
  </div>
</section>

<script>
/* ---------- state & storage ---------- */
const SKEY='wxai_v3';
let state = JSON.parse(localStorage.getItem(SKEY) || 'null') || {
  api:{base:'',key:'',model:'gpt-5'},
  groups:['æœªåˆ†ç»„'],
  worldbooks:[], // {id,title,content}
  roles:[],     // {id,remark,group,worlds[],aiPersona,myPersona,avatar,myAvatar,memory,chats:[]}
  moments:[]    // {id,text,img,imgDesc,time}
};
function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const uid =()=> 'id'+Math.random().toString(36).slice(2,9);
const timeStr = t => new Date(t).toLocaleString();
function el(tag, attrs={}, ...kids){
  const n = document.createElement(tag);
  for(const k in attrs){ if(k==='class') n.className=attrs[k]; else if(k==='html') n.innerHTML=attrs[k]; else n.setAttribute(k, attrs[k]); }
  kids.flat().filter(Boolean).forEach(c=> n.appendChild(typeof c==='string'?document.createTextNode(c):c));
  return n;
}
function openModal(id){ $('#'+id).classList.add('show'); }
function closeModal(id){ $('#'+id).classList.remove('show'); }
function maskClose(e,id){ if(e.target.id===id) closeModal(id); }

/* ---------- UI switching ---------- */
let currentTab='chatlist';
let currentRoleId=null;
function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $('#app-title').textContent = tab==='chatlist'?'æ¶ˆæ¯':tab==='contacts'?'é€šè®¯å½•':tab==='moments'?'æœ‹å‹åœˆ':tab==='me'?'æˆ‘çš„':'èŠå¤©';
  const buttons = document.querySelectorAll('nav.tabbar button');
  buttons.forEach(b=>b.classList.remove('active'));
  const idxMap = {chatlist:0,contacts:1,moments:2,me:3};
  if(idxMap[tab]!==undefined) buttons[idxMap[tab]].classList.add('active');
  $('#top-plus').style.display = (tab==='chatlist') ? 'inline-block' : 'none';
  if(tab==='chatlist'){ renderChatList(); $('#page-chatlist').classList.add('active'); }
  if(tab==='contacts'){ renderContacts(); $('#page-contacts').classList.add('active'); }
  if(tab==='moments'){ renderMoments(); $('#page-moments').classList.add('active'); }
  if(tab==='me'){ renderMe(); $('#page-me').classList.add('active'); }
}
$('#top-plus').addEventListener('click', ()=> openNewRoleSheet());

/* ---------- worldbook ---------- */
function addWorld(){
  const t = $('#wb-title').value.trim(), c = $('#wb-content').value.trim();
  if(!t || !c){ alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹'); return; }
  state.worldbooks.unshift({id:uid(), title:t, content:c});
  $('#wb-title').value=''; $('#wb-content').value='';
  save(); renderMe();
}
function removeWorld(id){
  state.worldbooks = state.worldbooks.filter(w=>w.id!==id); save(); renderMe();
}

/* ---------- groups ---------- */
function openManageGroups(){
  const box = $('#group-list'); box.innerHTML='';
  state.groups.forEach((g,idx)=>{
    const row = el('div',{class:'item'}, [
      el('div',{}, g),
      el('div',{style:'margin-left:auto'}, idx===0? el('span',{class:'small'},'é»˜è®¤') : el('button',{class:'pill',onclick:()=>{ if(confirm('åˆ é™¤åˆ†ç»„ï¼Ÿæ­¤æ“ä½œä¸ä¼šåˆ é™¤è”ç³»äººï¼Œä»…ä¼šå°†å…¶å½’å…¥æœªåˆ†ç»„')){ state.groups.splice(idx,1); save(); openManageGroups(); renderContacts(); } }},'åˆ é™¤') )
    ]);
    box.appendChild(row);
  });
  openModal('modal-groups');
}
function addGroup(){
  const v = $('#new-group-name').value.trim(); if(!v) return;
  if(!state.groups.includes(v)) state.groups.push(v);
  $('#new-group-name').value=''; save(); openManageGroups(); renderContacts();
}

/* ---------- chat list & contacts ---------- */
function renderChatList(){
  const wrap = $('#chatlist'); wrap.innerHTML='';
  if(state.roles.length===0){
    wrap.appendChild(el('div',{class:'item'}, [
      el('img',{class:'avatar'}),
      el('div',{}, [ el('div',{},'æš‚æ— è”ç³»äºº'), el('div',{class:'muted'}, 'ç‚¹å‡»å³ä¸Šè§’ï¼‹åˆ›å»ºè§’è‰²') ])
    ]));
    return;
  }
  state.roles.forEach(r=>{
    const last = r.chats[r.chats.length-1];
    const preview = last ? (last.type==='text'? last.text : last.type==='image'?'[å›¾ç‰‡]': last.type==='voice'?'[è¯­éŸ³]': last.type==='transfer'?'[è½¬è´¦]':'') : 'ç‚¹å‡»å¼€å§‹èŠå¤©';
    const it = el('div',{class:'item'}, [
      el('img',{class:'avatar',src:r.avatar||''}),
      el('div',{}, [ el('div',{}, r.remark), el('div',{class:'muted'}, preview) ]),
      el('div',{style:'margin-left:auto',class:'muted'}, last ? new Date(last.time).toLocaleTimeString().slice(0,5) : '' )
    ]);
    it.addEventListener('click', ()=> openChat(r.id));
    wrap.appendChild(it);
  });
}
function renderContacts(){
  const wrap = $('#contact-groups'); wrap.innerHTML='';
  state.groups.forEach(g=>{
    const sec = el('div',{class:'section'}, [ el('div',{class:'muted'}, g) ]);
    const list = el('div',{class:'list'});
    state.roles.filter(r=>r.group===g).forEach(r=>{
      const it = el('div',{class:'item'}, [
        el('img',{class:'avatar',src:r.avatar||''}),
        el('div',{}, [ el('div',{}, r.remark), el('div',{class:'muted'}, r.aiPersona? r.aiPersona.slice(0,40):'æ— äººè®¾') ])
      ]);
      it.addEventListener('click', ()=> openChat(r.id));
      list.appendChild(it);
    });
    sec.appendChild(list);
    wrap.appendChild(sec);
  });
}

/* ---------- moments ---------- */
function postMoment(){
  const text = $('#moment-text').value.trim();
  const img = $('#moment-img').value.trim();
  const imgDesc = $('#moment-img-desc').value.trim();
  if(!text && !img){ alert('è¯·è¾“å…¥æ–‡å­—æˆ–å›¾ç‰‡'); return; }
  state.moments.unshift({id:uid(), text, img, imgDesc, time: Date.now()});
  $('#moment-text').value=''; $('#moment-img').value=''; $('#moment-img-desc').value='';
  save(); renderMoments();
}
function clearMoments(){ if(confirm('æ¸…ç©ºæœ‹å‹åœˆï¼Ÿ')){ state.moments=[]; save(); renderMoments(); } }
function renderMoments(){
  const wrap = $('#moments-list'); wrap.innerHTML='';
  if(state.moments.length===0) { wrap.appendChild(el('div',{class:'muted'}, 'è¿˜æ²¡æœ‰åŠ¨æ€')); return; }
  state.moments.forEach(m=>{
    const node = el('div',{class:'moment'}, [
      el('div',{}, m.text),
      m.img ? el('div',{}, [ el('img',{src:m.img, style:'max-width:100%;border-radius:8px;margin-top:8px'}), el('div',{class:'small muted'}, m.imgDesc||'') ]) : '',
      el('div',{class:'small muted'}, timeStr(m.time))
    ]);
    wrap.appendChild(node);
  });
}

/* ---------- my (api, worldbook rendering) ---------- */
function saveApi(){
  state.api.base = $('#api-base').value.trim();
  state.api.key  = $('#api-key').value.trim();
  state.api.model= $('#api-model').value.trim() || 'gpt-5';
  save(); alert('å·²ä¿å­˜ API è®¾ç½®');
}
async function testApi(){
  if(!state.api.base || !state.api.key){ alert('è¯·å…ˆå¡«å†™ BaseURL ä¸ Key'); return;}
  try{
    const res = await fetch(state.api.base + '/models', { headers:{ Authorization:'Bearer '+state.api.key } });
    alert(res.ok? 'API å¯ç”¨' : 'API è¯·æ±‚å¤±è´¥ï¼ˆæ³¨æ„ CORS ä¸ URLï¼‰');
  }catch(e){ alert('è¯·æ±‚å¤±è´¥ï¼š'+e.message); }
}
function renderMe(){
  $('#api-base').value = state.api.base || '';
  $('#api-key').value = state.api.key || '';
  $('#api-model').value = state.api.model || 'gpt-5';
  const wb = $('#worldbook-list'); wb.innerHTML='';
  if(state.worldbooks.length===0) wb.appendChild(el('div',{class:'muted'},'æš‚æ— ä¸–ç•Œä¹¦'));
  state.worldbooks.forEach(w=>{
    const node = el('div',{class:'item'}, [
      el('div',{}, el('div',{}, w.title), el('div',{class:'muted'}, w.content.slice(0,80) + (w.content.length>80?'...':''))),
      el('div',{style:'margin-left:auto'}, el('button',{class:'pill',onclick:()=>{ if(confirm('åˆ é™¤ä¸–ç•Œä¹¦ï¼Ÿ')){ removeWorld(w.id); } }},'åˆ é™¤'))
    ]);
    wb.appendChild(node);
  });
}

/* ---------- create role ---------- */
function openNewRoleSheet(){
  // fill groups and worldbooks
  const gsel = $('#nr-group'); gsel.innerHTML='';
  state.groups.forEach(g=> gsel.appendChild(el('option',{value:g}, g)));
  const wrap = $('#nr-worldbooks'); wrap.innerHTML='';
  state.worldbooks.forEach(w=> wrap.appendChild(el('label',{class:'pill'}, [ el('input',{type:'checkbox',value:w.id, style:'margin-right:6px'}), w.title ]) ));
  $('#nr-avatar').value=''; $('#nr-avatar-preview').src='';
  $('#nr-my-avatar').value=''; $('#nr-my-avatar-preview').src='';
  $('#nr-remark').value=''; $('#nr-ai-persona').value=''; $('#nr-my-persona').value=''; $('#nr-memory').value=12;
  openModal('modal-newrole');
}
function confirmNewRole(){
  const remark = $('#nr-remark').value.trim() || 'æœªå‘½å';
  const group = $('#nr-group').value || state.groups[0];
  const worlds = [...document.querySelectorAll('#nr-worldbooks input:checked')].map(i=>i.value);
  const aiPersona = $('#nr-ai-persona').value.trim();
  const myPersona = $('#nr-my-persona').value.trim();
  const avatar = $('#nr-avatar').value.trim();
  const myAvatar = $('#nr-my-avatar').value.trim();
  const memory = Math.max(4, Math.min(50, parseInt($('#nr-memory').value||12)));
  const r = { id:uid(), remark, group, worlds, aiPersona, myPersona, avatar, myAvatar, memory, chats:[] };
  state.roles.unshift(r); save(); closeModal('modal-newrole'); switchTab('chatlist'); renderChatList();
}
/* preview avatar in modal */
$('#nr-avatar').addEventListener('input', e=> $('#nr-avatar-preview').src = e.target.value );
$('#nr-my-avatar').addEventListener('input', e=> $('#nr-my-avatar-preview').src = e.target.value );

/* ---------- open chat ---------- */
function openChat(roleId){
  currentRoleId = roleId;
  const role = state.roles.find(r=>r.id===roleId); if(!role) return;
  $('#app-title').textContent = role.remark;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $('#page-chat').classList.add('active');
  renderChat(roleId);
}

/* render chat UI for role */
function renderChat(roleId){
  const role = state.roles.find(r=>r.id===roleId);
  const page = $('#page-chat'); page.innerHTML='';
  const wrap = el('div',{class:'chat-wrap'});
  // top quick
  wrap.appendChild(el('div',{class:'row',style:'padding:8px 10px;gap:8px;background:#fff;border-bottom:1px solid var(--line)'}, [
    el('button',{class:'pill',onclick:()=>openRoleSettings(roleId)}, 'è®¾ç½®'),
    el('div',{class:'muted'}, `å¯¹æ–¹äººè®¾ï¼š${role.aiPersona? role.aiPersona.slice(0,40):'æ— '} Â· è®°å¿† ${role.memory||12}`)
  ]));
  // chat list
  const list = el('div',{class:'chat-list',id:'chat-list'});
  role.chats.forEach(c=> list.appendChild(renderBubble(c)));
  wrap.appendChild(list);
  // input bar
  const bar = el('div',{class:'chat-inputbar'});
  const tools = el('div',{class:'tools'});
  const emoBtn = el('button',{class:'pill',id:'btn-emo'}, 'è¡¨æƒ…åŒ…');
  const inputBox = el('input',{id:'chat-input',placeholder:'è¾“å…¥æ¶ˆæ¯...'});
  const sendBtn = el('button',{class:'pill'}, 'å‘é€');
  const recvBtn = el('button',{class:'pill'}, 'æ¥æ”¶');
  const plusBtn = el('button',{class:'pill'}, '+');
  tools.append(emoBtn, inputBox, sendBtn, recvBtn, plusBtn);
  bar.appendChild(tools);

  // emo panel
  const emoPanel = el('div',{class:'emo-panel',id:'emo-panel',style:'display:none'}, [
    el('div',{}, 'æ’å…¥å›¾ç‰‡ URL + åç§°ï¼ˆç»™ AI è¯†åˆ«ï¼‰ï¼š'),
    el('input',{id:'emo-url',placeholder:'https://...png'}),
    el('input',{id:'emo-name',placeholder:'è´´å›¾åç§°ï¼Œä¾‹å¦‚ï¼šç¬‘å“­'}),
    el('div',{class:'row',style:'margin-top:6px'}, [ el('button',{class:'btn'}, 'å‘é€è´´å›¾'), el('button',{class:'btn ghost'}, 'æ”¶èµ·') ])
  ]);
  // plus panel
  const plusPanel = el('div',{class:'plus-panel',id:'plus-panel',style:'display:none'}, [
    el('div',{class:'grid3'}, [
      el('button',{class:'pill'}, 'ğŸ“· ç…§ç›¸æœº'),
      el('button',{class:'pill'}, 'ğŸ¤ è¯­éŸ³'),
      el('button',{class:'pill'}, 'Â¥ è½¬è´¦')
    ])
  ]);
  bar.appendChild(emoPanel); bar.appendChild(plusPanel);
  wrap.appendChild(bar);
  page.appendChild(wrap);

  // wire events (closures to keep roleId)
  emoBtn.addEventListener('click', ()=> emoPanel.style.display = emoPanel.style.display==='none'?'block':'none');
  plusBtn.addEventListener('click', ()=> plusPanel.style.display = plusPanel.style.display==='none'?'block':'none');

  sendBtn.addEventListener('click', ()=> {
    const v = inputBox.value.trim(); if(!v) return;
    pushChat(roleId, {role:'user', type:'text', text:v});
    inputBox.value='';
  });
  // emo send
  emoPanel.querySelector('.btn').addEventListener('click', ()=> {
    const url = emoPanel.querySelector('#emo-url').value.trim();
    const name = emoPanel.querySelector('#emo-name').value.trim() || 'è´´å›¾';
    if(!url){ alert('è¯·è¾“å…¥å›¾ç‰‡ URL'); return; }
    pushChat(roleId, {role:'user', type:'image', text:`[è´´å›¾] ${name}`, meta:{url, name}});
    emoPanel.querySelector('#emo-url').value=''; emoPanel.querySelector('#emo-name').value='';
  });
  emoPanel.querySelector('.btn.ghost').addEventListener('click', ()=> emoPanel.style.display='none');

  // plus panel items
  const plusBtns = plusPanel.querySelectorAll('button');
  plusBtns[0].addEventListener('click', ()=> { // camera
    const desc = prompt('æ·»åŠ å›¾ç‰‡æè¿°ï¼ˆå°†ä½œä¸ºæ¶ˆæ¯å‘é€ï¼‰');
    if(desc===null) return;
    pushChat(roleId, {role:'user', type:'image', text:desc, meta:{name:'ç›¸æœºå›¾ç‰‡', url:''}});
  });
  plusBtns[1].addEventListener('click', ()=> { // voice
    const desc = prompt('æ·»åŠ è¯­éŸ³æè¿°ï¼ˆè™šæ‹Ÿå‘é€ï¼‰');
    if(desc===null) return;
    pushChat(roleId, {role:'user', type:'voice', text:'[è¯­éŸ³]', meta:{desc}});
  });
  plusBtns[2].addEventListener('click', ()=> { // transfer
    const amt = prompt('è¾“å…¥é‡‘é¢ï¼ˆå…ƒï¼‰');
    if(amt===null) return;
    const note = prompt('å¤‡æ³¨ï¼ˆå¯ç©ºï¼‰')||'';
    pushChat(roleId, {role:'user', type:'transfer', text:'[è½¬è´¦]', meta:{amount: Number(amt)||0, note}});
  });

  // receive: call API or simulate
  recvBtn.addEventListener('click', ()=> receiveAI(roleId));

  list.scrollTop = list.scrollHeight;
}

/* bubble renderer */
function renderBubble(c){
  const sideClass = c.role==='user' ? 'me' : 'ai';
  const row = el('div',{class:sideClass});
  const b = el('div',{class:'bubble'});
  if(c.type==='text') b.textContent = c.text;
  else if(c.type==='image'){
    b.innerHTML = `<div style="font-size:12px;color:#666">${c.meta?.name||'å›¾ç‰‡'}</div>
                   ${c.meta?.url? `<img src="${c.meta.url}" style="max-width:180px;border-radius:8px;border:1px solid var(--line)" onerror="this.style.display='none'"/>` : ''}
                   <div style="margin-top:6px">${c.text||''}</div>`;
  }else if(c.type==='voice'){
    b.innerHTML = `<div>ğŸ¤ è¯­éŸ³ï¼š${c.meta?.desc||''}</div>`;
  }else if(c.type==='transfer'){
    b.innerHTML = `<div>Â¥ è½¬è´¦ï¼š${c.meta?.amount||0} å…ƒ</div><div class="muted">${c.meta?.note||''}</div>`;
  }else{
    b.textContent = c.text;
  }
  row.appendChild(b);
  return row;
}

/* push chat and update display */
function pushChat(roleId, obj){
  const r = state.roles.find(x=>x.id===roleId); if(!r) return;
  r.chats.push({...obj, time: Date.now()});
  save();
  const list = $('#chat-list');
  if(list) list.appendChild(renderBubble({...obj, time: Date.now()}));
  // refresh preview
  renderChatList();
  // scroll
  setTimeout(()=>{ if(list) list.scrollTop = list.scrollHeight; },80);
}

/* ---------- receive AI (uses API if configured, else simulate) ---------- */
async function receiveAI(roleId){
  const r = state.roles.find(x=>x.id===roleId); if(!r) return;
  // append a loading bubble
  const loading = {role:'assistant', type:'text', text:'å¯¹æ–¹æ­£åœ¨è¾“å…¥â€¦', time: Date.now()};
  pushChat(roleId, loading);

  // prepare system prompt and message history
  const sysParts = [
    'ä½ æ˜¯ä¸€ä½çœŸå®çš„äººç±»æœ‹å‹ï¼Œæ­£åœ¨é€šè¿‡å¾®ä¿¡ç§èŠã€‚ä¸è¦æš´éœ²è‡ªå·±æ˜¯ AIã€‚',
    'å›ç­”è¦è‡ªç„¶ã€æœ‰æ¸©åº¦ï¼Œæ¯æ¬¡å›å¤ 4 åˆ° 6 å¥è¯ã€‚',
  ];
  if(r.aiPersona) sysParts.push('å¯¹æ–¹ï¼ˆä½ ï¼‰çš„è§’è‰²äººè®¾ï¼š' + r.aiPersona);
  if(r.worlds && r.worlds.length){
    const wbContents = r.worlds.map(wid => {
      const w = state.worldbooks.find(x=>x.id===wid);
      return w ? `${w.title}: ${w.content}` : '';
    }).filter(Boolean).join('\n');
    if(wbContents) sysParts.push('ä¸–ç•Œä¹¦è®¾å®šï¼š' + wbContents);
  }
  if(r.myPersona) sysParts.push('æˆ‘ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾ï¼š' + r.myPersona);
  const systemPrompt = sysParts.join('\n');

  // prepare messages from last N
  const recent = r.chats.slice(-Math.max(4, r.memory||12)).map(c=>{
    if(c.type==='text') return {role: c.role==='user' ? 'user':'assistant', content: c.text};
    if(c.type==='image') return {role: c.role==='user' ? 'user':'assistant', content: `[å›¾ç‰‡] ${c.meta?.name||''} ${c.text||''} ${c.meta?.url||''}`};
    if(c.type==='voice') return {role: c.role==='user' ? 'user':'assistant', content: `[è¯­éŸ³] ${c.meta?.desc||''}`};
    if(c.type==='transfer') return {role: c.role==='user' ? 'user':'assistant', content: `[è½¬è´¦] é‡‘é¢:${c.meta?.amount||0} å¤‡æ³¨:${c.meta?.note||''}`};
    return {role: c.role==='user' ? 'user':'assistant', content: c.text||''};
  });

  // call API if configured
  let aiText = '';
  if(state.api.base && state.api.key && state.api.model){
    try{
      const body = { model: state.api.model, messages: [{role:'system', content: systemPrompt}, ...recent] };
      const res = await fetch(state.api.base + '/chat/completions', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+state.api.key }, body: JSON.stringify(body)
      });
      const data = await res.json();
      aiText = data?.choices?.[0]?.message?.content || ('ï¼ˆAPI æ— è¿”å›ï¼‰');
    }catch(e){
      aiText = 'è¯·æ±‚ API å¤±è´¥ï¼š' + e.message;
    }
  }else{
    // æ¨¡æ‹Ÿå›å¤ï¼šç®€å•ç»“åˆ persona & worldbook
    aiText = `${r.aiPersona?('ä½œä¸ºï¼š'+r.aiPersona+'ï¼Œ') : ''}æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ï¼Œ${Math.random()<0.5?'æˆ‘ä¹Ÿæœ‰åŒæ„Ÿã€‚':'æˆ‘ä¼šè®¤çœŸå›å¤ä½ çš„ã€‚'}ï¼ˆæ¨¡æ‹Ÿå›å¤ï¼‰`;
    // ensure 4-6 short sentences: if only one, split
    if(aiText.split('ã€‚').length<4) aiText += ' æˆ‘è§‰å¾—è¿™æ ·ã€‚ ä¹Ÿè®¸å¯ä»¥è¯•è¯•è¿™ä¸ªã€‚ å¸Œæœ›æœ‰å¸®åŠ©ã€‚';
  }

  // remove the loading bubble (last assistant)
  r.chats = r.chats.filter((c,i)=> !(c.role==='assistant' && c.text==='å¯¹æ–¹æ­£åœ¨è¾“å…¥â€¦' && i===r.chats.length-1));
  // push real reply
  pushChat(roleId, {role:'assistant', type:'text', text: aiText});
}

/* ---------- role settings ---------- */
function openRoleSettings(roleId){
  const r = state.roles.find(x=>x.id===roleId); if(!r) return;
  $('#rs-remark').value = r.remark || '';
  // groups
  const sel = $('#rs-group'); sel.innerHTML='';
  state.groups.forEach(g=> sel.appendChild(el('option',{value:g}, g)));
  sel.value = r.group || state.groups[0];
  // worldbooks
  const wrap = $('#rs-worldbooks'); wrap.innerHTML='';
  state.worldbooks.forEach(w=> {
    const chk = el('input',{type:'checkbox',value:w.id, style:'margin-right:6px'}); chk.checked = (r.worlds||[]).includes(w.id);
    const lb = el('label',{class:'pill'}, [ chk, w.title ] );
    wrap.appendChild(lb);
  });
  $('#rs-ai-persona').value = r.aiPersona || '';
  $('#rs-my-persona').value = r.myPersona || '';
  $('#rs-avatar').value = r.avatar || '';
  $('#rs-my-avatar').value = r.myAvatar || '';
  $('#rs-avatar-preview').src = r.avatar || '';
  $('#rs-my-avatar-preview').src = r.myAvatar || '';
  $('#rs-avatar').addEventListener('input', e=> $('#rs-avatar-preview').src = e.target.value );
  $('#rs-my-avatar').addEventListener('input', e=> $('#rs-my-avatar-preview').src = e.target.value );
  $('#rs-memory').value = r.memory || 12;
  openModal('modal-role-settings');
}
function saveRoleSettings(){
  const r = state.roles.find(x=>x.id===currentRoleId); if(!r) return;
  r.remark = $('#rs-remark').value.trim() || r.remark;
  r.group = $('#rs-group').value || r.group;
  r.worlds = [...document.querySelectorAll('#rs-worldbooks input:checked')].map(i=>i.value);
  r.aiPersona = $('#rs-ai-persona').value.trim();
  r.myPersona = $('#rs-my-persona').value.trim();
  r.avatar = $('#rs-avatar').value.trim();
  r.myAvatar = $('#rs-my-avatar').value.trim();
  r.memory = Math.max(4, Math.min(50, parseInt($('#rs-memory').value||12)));
  save(); closeModal('modal-role-settings'); renderChatList(); renderContacts(); if(currentRoleId) openChat(currentRoleId);
}

/* ---------- render & init ---------- */
function renderAll(){ renderChatList(); renderContacts(); renderMoments(); renderMe(); }
renderAll(); switchTab('chatlist');

/* wire some remaining UI events */
$('#wb-title')?.addEventListener('keydown', e=> { if(e.key==='Enter'){ addWorld(); } });
$('#api-base')?.addEventListener('keydown', e=> { if(e.key==='Enter'){ saveApi(); } });

/* expose some functions to global (for inline onclick) */
window.switchTab = switchTab;
window.openManageGroups = openManageGroups;
window.addGroup = addGroup;
window.postMoment = postMoment;
window.clearMoments = clearMoments;
window.saveApi = saveApi;
window.testApi = testApi;
window.addWorld = addWorld;
window.openNewRoleSheet = openNewRoleSheet;
window.confirmNewRole = confirmNewRole;
window.openRoleSettings = function(id){ currentRoleId=id; openRoleSettings(id); };
window.closeModal = closeModal;
window.maskClose = maskClose;
</script>
</body>
</html>